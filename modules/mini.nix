{ config, pkgs, lib, ... }:

let
  # Read hostname from local config file (generated by bootstrap)
  hostnameFile =
    if builtins.pathExists /etc/nix-darwin/hostname.local
    then /etc/nix-darwin/hostname.local
    else ../hostname.local;
  hostname = if builtins.pathExists hostnameFile
    then lib.strings.trim (builtins.readFile hostnameFile)
    else "mini-default";

  # Read username for activation script
  usernameFile =
    if builtins.pathExists /etc/nix-darwin/username.local
    then /etc/nix-darwin/username.local
    else ../username.local;
  username = if builtins.pathExists usernameFile
    then lib.strings.trim (builtins.readFile usernameFile)
    else "runner";
in
{
  # Disable Homebrew for mini profile - not needed, all packages come from Nix
  nix-homebrew.enable = lib.mkForce false;
  homebrew.enable = lib.mkForce false;

  # Set hostname to mini-${serial_number}
  networking = {
    hostName = hostname;
    computerName = hostname;
    localHostName = hostname;
  };

  # Install orchard for VM orchestration and podman for containers
  environment.systemPackages = [
    pkgs.orchard
    pkgs.tailscale
    pkgs.podman
    pkgs.podman-compose
    pkgs.qemu
  ];

  # Initialize and start podman machine on activation
  system.activationScripts.postActivation.text = ''
    echo "Configuring podman..."
    # Initialize podman machine if not exists (-H sets HOME to target user's home)
    if ! sudo -H -u ${username} ${pkgs.podman}/bin/podman machine list 2>/dev/null | grep -q "podman-machine-default"; then
      echo "Initializing podman machine..."
      sudo -H -u ${username} ${pkgs.podman}/bin/podman machine init || true
    fi
    # Start podman machine if not running
    if ! sudo -H -u ${username} ${pkgs.podman}/bin/podman machine list 2>/dev/null | grep -q "Running"; then
      echo "Starting podman machine..."
      sudo -H -u ${username} ${pkgs.podman}/bin/podman machine start || true
    fi
  '';
}
